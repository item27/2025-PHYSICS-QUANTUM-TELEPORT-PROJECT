# WebSocket протокол

## 1. Назначение
Описание обмена сообщениями в сетевом режиме Quantum Teleportation Visualizer.

## 2. Подключение
- URL: `/api/ws?session={id}&token={token}`.
- Токен выдаётся через `POST /api/sessions/{id}/join` и привязан к роли.
- Одновременно может быть несколько клиентов на разные роли; повторное подключение по тому же токену заменяет старое соединение.

## 3. Формат сообщений
Все сообщения в JSON.

### Сообщения от сервера
- `state`: актуальное состояние сессии (id, текущий шаг, роли и их статусы, результаты измерений, флаги подключения).
- `error`: описание ошибки, если действие клиента отклонено.
- `info`: служебные уведомления (подключение роли, освобождение роли, переход шага).

### Сообщения от клиента
- `advance`: запросить переход на следующий шаг протокола (разрешено только для роли, имеющей право на текущем шаге).
- `ping`: проверка соединения.

## 4. Правила перехода шагов
- Алиса или Боб подготавливает пару Белла.
- Alice выполняет беллово измерение.
- Bob применяет коррекцию.
- Сервер отклоняет действие, если шаг не соответствует роли или сессия неактивна.

## 5. Обработка ошибок и разрывов
- При потере связи роль помечается как отключённая; слот освобождается через TTL или явный `leave`.
- Ошибки валидации возвращаются в поле `error` и не меняют состояние.
- Сервер закрывает соединение при неверном токене или отсутствии сессии.

## 6. Definition of Done
- Подключение с валидным токеном всегда получает текущее состояние.
- Любое валидное действие обновляет состояние и рассылается всем подключённым клиентам сессии.
- Ошибочные действия не меняют состояние и сопровождаются понятным сообщением.
