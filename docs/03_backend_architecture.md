# Архитектура backend (Go)

## 1. Назначение
Краткое описание устройства backend для Quantum Teleportation Visualizer. Опираться нужно на этот документ при доработках сервера.

## 2. Технологии
- Go стандартная библиотека.
- `net/http` для REST, WebSocket-апгрейд через `gorilla/websocket` или аналогичный лёгкий слой.
- Логи через `slog`.

## 3. Основные компоненты
- **Модель сессии**: идентификатор, шаг протокола, роли (Alice, Bob), их токены и статус подключения, текущие результаты измерений.
- **Сервис сессий**: создание, чтение, переход по шагам, валидация разрешённых действий, TTL/освобождение ролей.
- **REST-контроллеры**: создание сессии, получение состояния, join/leave, advance; валидация входных данных и ошибок.
- **WebSocket-хаб**: хранит подключения по сессиям и ролям, рассылает обновления состояния после действий.

## 4. Потоки данных
1. Клиент создаёт сессию через REST и получает ID.
2. Клиент выбирает роль, вызывает join, получает токен и текущее состояние.
3. WebSocket подключается с параметрами `session` и `token`; сервер проверяет роль и добавляет соединение в хаб.
4. Разрешённое действие (например, переход шага) вызывает обновление состояния в сервисе сессий.
5. Хаб отправляет новое состояние всем подключённым клиентам сессии.

## 5. Валидация и ошибки
- Join возможен только на свободную роль; занятая роль возвращает 409.
- Действия разрешены только тем, у кого есть действующий токен и подходящий шаг протокола.
- Некорректные параметры возвращают 400, неожиданные ошибки - 500.

## 6. Хранение и конфигурация
- Состояние сессий хранится в памяти (MVP).
- Порты и базовые адреса настраиваются переменными окружения.

## 7. Definition of Done для backend
- Все маршруты из `api/openapi.yaml` реализованы.
- Валидация шагов и ролей соответствует протоколу.
- WebSocket отправляет актуальные состояния после каждого действия.
- Логи отражают ключевые события: создание сессии, подключение, изменение шага, ошибки валидации.
